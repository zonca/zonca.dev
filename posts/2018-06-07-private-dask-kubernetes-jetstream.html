<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2018-06-07">

<title>Andrea Zonca - Setup private dask clusters in Kubernetes alongside JupyterHub on Jetstream</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Andrea Zonca</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../consult.html">Consulting</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zonca"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/andreazonca"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Setup private dask clusters in Kubernetes alongside JupyterHub on Jetstream</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">jupyterhub</div>
                <div class="quarto-category">kubernetes</div>
                <div class="quarto-category">jetstream</div>
                <div class="quarto-category">dask</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 7, 2018</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>In this post we will leverage software made available by the <a href="https://pangeo-data.github.io">Pangeo community</a> to allow each user of a <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">Jupyterhub instance deployed on Jetstream on top of Kubernetes</a> to launch a set of <a href="https://dask.pydata.org"><code>dask</code></a> workers as containers running inside Kubernetes itself and use them for distributed computing.</p>
<p>Pangeo also maintains a deployment of this environment on Google Cloud freely accessible at <a href="https://pangeo.pydata.org">pangeo.pydata.org</a>.</p>
<p><strong>Security considerations</strong>: This deployment grants each user administrative access to the Kubernetes API, so each user could use this privilege to terminate other users’ pods or dask workers. Therefore it is suitable only for a community of trusted users. There is <a href="https://github.com/pangeo-data/pangeo/issues/135#issuecomment-384320753">discussion about leveraging namespaces to limit this</a> but it hasn’t been implemented yet.</p>
<section id="deploy-kubernetes" class="level2">
<h2 class="anchored" data-anchor-id="deploy-kubernetes">Deploy Kubernetes</h2>
<p>We need to first create Jetstream instances and deploy Kubernetes on them. We can follow the first part of the tutorial at <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html</a>. I also tested with Ubuntu 18.04 instead of Ubuntu 16.04 and edited the <code>install-kubeadm.bash</code> accordingly, I also removed version specifications in order to pickup the latest Kubernetes version, currently 1.10. See <a href="https://gist.github.com/zonca/5365fd2245462dedaf2297e0417c4662">my install-kubeadm-18.04.bash</a>. Notice that for the <code>http://apt.kubernetes.io/</code> don’t have yet Ubuntu 18.04 packages, so I left <code>xenial</code>, this should be updated in the future.</p>
<p>In order to simplify the setup we will just be using ephemeral storage, later we can update the deployment using either Rook following the <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">steps in my original tutorial</a> or a NFS share (I’ll write a tutorial soon about that).</p>
</section>
<section id="deploy-pangeo" class="level2">
<h2 class="anchored" data-anchor-id="deploy-pangeo">Deploy Pangeo</h2>
<p>Deployment is just a single step because Pangeo published a Helm recipe that depends on the Zero-to-JupyterHub recipe and deploys both in a single step, therefore we <em>should not have deployed JupyterHub beforehand</em>.</p>
<p>First we need to create a <code>yaml</code> configuration file for the package. Checkout the Github repository with all the configuration files on the master node of Kubernetes:</p>
<pre><code>git clone https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream</code></pre>
<p>in the <code>pangeo_helm</code> folder, there is already a draft of the configuration file.</p>
<p>We need to:</p>
<ul>
<li>run <code>openssl</code> as instructed inside the file and paste the output tokens to the specified location</li>
<li>edit the hostname in the <code>ingress</code> section to the hostname of the Jetstream master node</li>
<li>customize the memory and CPU requirements, currently they are very low so that this can be tested also in a single small instance</li>
</ul>
<p>We can then deploy with:</p>
<pre><code>sudo helm install pangeo/pangeo -n pangeo --namespace pangeo -f config_pangeo_no_storage.yaml --version=v0.1.1-95ab292</code></pre>
<p>You can optionally check if there are newer versions of the chart at <a href="https://pangeo-data.github.io/helm-chart/">https://pangeo-data.github.io/helm-chart/</a>.</p>
<p>Then check that the pods start checking their status with:</p>
<pre><code>sudo kubectl -n pangeo get pods</code></pre>
<p>If any is stuck in Pending, check with:</p>
<pre><code>sudo kubectl -n pangeo describe &lt;pod-name&gt;</code></pre>
<p>Once the <code>hub</code> pod is running, you should be able to connect with your browser to <code>js-xxx-xxx.Jetstream-cloud.org</code>, by default it runs with a dummy authenticator, at the login form, just type any username and leave the password empty to login.</p>
</section>
<section id="launch-a-dask-cluster" class="level2">
<h2 class="anchored" data-anchor-id="launch-a-dask-cluster">Launch a dask cluster</h2>
<p>Once you get the Jupyter Notebook instance, you should see a file named <code>worker-template.yaml</code> in your home folder, this is a template for the configuration and the allocated resources for the pod of each <code>dask</code> worker. The default workers for Pangeo are beefy, for testing we can reduce their requirements, see for example my <a href="https://gist.github.com/zonca/21ef3125eee7af5c2548e505d47dc200">worker-template.yaml</a> that works on a small Jetstream VM.</p>
<p>Then inside <code>examples/</code> we have several example notebooks that show how to use <code>dask</code> for distributed computing. <code>dask-array.ipynb</code> shows basic functionality for distributed multi-dimensional arrays.</p>
<p>The most important piece of code is the creation of dask workers:</p>
<pre><code>from dask_kubernetes import KubeCluster
cluster = KubeCluster(n_workers=2)
cluster</code></pre>
<p>If we execute this cell <code>dask_kubernetes</code> contacts the Kubernetes API using the <a href="https://github.com/pangeo-data/helm-chart/blob/master/pangeo/templates/dask-kubernetes-rbac.yaml">serviceaccount <code>daskkubernetes</code></a> mounted on the pods by the Helm chart and requests new pods to be launched. In fact we can check on the terminal again with:</p>
<pre><code>sudo kubectl -n pangeo get pods</code></pre>
<p>that new pods should be about to run. It also provides buttons to change the number of running workers, either manually or adaptively based on the required resources.</p>
<p>This also runs the <code>dask</code> scheduler on the pod that is running the Jupyter Notebook and we can connect to it with:</p>
<pre><code>from dask.distributed import Client
client = Client(cluster)
client</code></pre>
<p>From now on all <code>dask</code> commands will automatically execute commands on the <code>dask</code> cluster.</p>
</section>
<section id="customize-the-jupyterhub-deployment" class="level2">
<h2 class="anchored" data-anchor-id="customize-the-jupyterhub-deployment">Customize the JupyterHub deployment</h2>
<p>We can then customize the JupyterHub deployment for example to add authentication or permanent storage. Notice that all configuration options inside the <code>config_pangeo_no_storage.yaml</code> are inside the <code>jupyterhub:</code> tag, this is due to the fact that <code>jupyterhub</code> is another Helm package which we are configuring through the <code>pangeo</code> Helm package. Therefore make sure that any configuration option found in my previous tutorials or on the <a href="https://zero-to-jupyterhub.readthedocs.io/en/latest/">Zero-to-Jupyterhub</a> documentation needs to be indented accordingly.</p>
<p>Then we can either run:</p>
<pre><code>sudo helm delete --purge pangeo</code></pre>
<p>and then install it from scratch again or just update the running cluster with:</p>
<pre><code>sudo helm upgrade pangeo -f config_pangeo_no_storage.yaml</code></pre>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>