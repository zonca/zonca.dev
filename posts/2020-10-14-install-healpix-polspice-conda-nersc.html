<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2020-10-14">

<title>zonca.dev - Install HEALPix and PolSpice in a conda environment</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">zonca.dev</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zonca"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/andreazonca"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Install HEALPix and PolSpice in a conda environment</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">healpy</div>
                <div class="quarto-category">hpc</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">October 14, 2020</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>Some notes on how to install HEALPix and PolSpice inside a conda environment, with some details about doing it at NERSC, but most of the tutorial is independent of that.</p>
<section id="setup-the-conda-environment-and-the-compilers" class="level2">
<h2 class="anchored" data-anchor-id="setup-the-conda-environment-and-the-compilers">Setup the conda environment and the compilers</h2>
<p>I assume here we are installing it into a custom conda environement the possibly contains all other cosmology packages, like <code>healpy</code>.</p>
<p>For example created with:</p>
<pre><code>module load python
conda create -n pycmb python==3.7 healpy matplotlib ipykernel</code></pre>
<p>When you activate the conda environment, the variable <code>$CONDA_PREFIX</code> is automatically set to the base folder of the environment, something like:</p>
<pre><code>~/anaconda/envs/pycmb</code></pre>
<p>To make it simpler, I am using <code>gcc</code> and <code>gfortran</code>, if at NERSC run:</p>
<pre><code>module load PrgEnv-gnu</code></pre>
<p>if that fails, probably you need first to unload the Intel environment:</p>
<pre><code>module unload PrgEnv-intel
module load PrgEnv-gnu</code></pre>
</section>
<section id="install-cfitsio" class="level2">
<h2 class="anchored" data-anchor-id="install-cfitsio">Install cfitsio</h2>
<p><code>cfitsio</code> is quite easy, better download the version included in <code>healpy</code> because it has a couple of fixes:</p>
<pre><code>git clone https://github.com/healpy/cfitsio
cd cfitsio</code></pre>
<p>We want to install it into a dedicated folder, not the same <code>lib</code> folder of the conda environment, so that we don’t risk to have conflicts with the compiler libraries during the build process:</p>
<pre><code>./configure --prefix=$CONDA_PREFIX/cfitsio
make -j8 shared install</code></pre>
</section>
<section id="install-healpix" class="level2">
<h2 class="anchored" data-anchor-id="install-healpix">Install HEALPix</h2>
<p>HEALPix installs itself in the same folder where it is unpacked, and then modifies the bash profile to make things work. As we want to keep things isolated, let’s unpack the Healpix package into the conda environment folder, so it will be something like:</p>
<pre><code>$CONDA_PREFIX/Healpix_3.70

./configure</code></pre>
<p>configure the C, the Fortran packages, the Fortran package requires <code>libsharp</code>, set everything to default except location of <code>cfitsio</code> where you need (notice <code>lib</code> at the end):</p>
<pre><code>$CONDA_PREFIX/cfitsio/lib</code></pre>
<p>When the installer asks whether to modify <code>.profile</code> respond no. Now the installer will create some scripts in the <code>~/.healpix</code> folder and modify <code>.profile</code>, we want to only activate HEALPix in our conda environment so we should modify <code>.profile</code> and remove the lines added by HEALPix.</p>
<p>Finally we can have HEALPix automatically activated when the conda environment is initialized (notice we need the script to end in <code>.sh</code>):</p>
<pre><code>mkdir -p ${CONDA_PREFIX}/etc/conda/activate.d
ln -s ~/.healpix/3_70_Linux/config ${CONDA_PREFIX}/etc/conda/activate.d/config.sh</code></pre>
<p>Restart the conda environment, and try to run <code>anafast</code> to check that it works. If you are at NERSC, make sure that you are always loading the GNU programming environment by having:</p>
<pre><code>module swap PrgEnv-intel PrgEnv-gnu</code></pre>
<p>in <code>.bashrc.ext</code>.</p>
</section>
<section id="install-polspice" class="level2">
<h2 class="anchored" data-anchor-id="install-polspice">Install PolSpice</h2>
<p>Create a <code>build</code> folder inside the source folder and create a <code>run.sh</code> file with this content:</p>
<pre><code>cmake .. -DCFITSIO=${CONDA_PREFIX}/cfitsio/lib -DCMAKE_Fortran_COMPILER=gfortran -DCMAKE_C_COMPILER=gcc</code></pre>
<p>Then:</p>
<pre><code>bash run.sh
make -j8</code></pre>
<p>This will put the <code>spice</code> executable into the <code>../bin</code> folder, just copy it to the conda environment bin folder:</p>
<pre><code>cd ..
cp bin/spice ${CONDA_PREFIX}/bin/</code></pre>
<p>We can also copy the 2 python modules into the environment:</p>
<pre><code>cp bin/bin_llcl.py bin/ispice.py ${CONDA_PREFIX}/lib/python3.*/site-packages/</code></pre>
<p>Check it works:</p>
<pre><code>spice -usage</code></pre>
<section id="uninstall-polspice" class="level3">
<h3 class="anchored" data-anchor-id="uninstall-polspice">Uninstall PolSpice</h3>
<pre><code>rm ${CONDA_PREFIX}/bin/spice ${CONDA_PREFIX}/lib/python3.*/site-packages/bin_llcl.py ${CONDA_PREFIX}/lib/python3.*/site-packages/ispice.py</code></pre>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>