<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.171">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2023-06-19">

<title>Andrea Zonca - Deploy Kubernetes on Jetstream 2 with Kubespray 2.21.0</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Andrea Zonca</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../consult.html">
 <span class="menu-text">Consulting</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zonca"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/andreazonca"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://mastodon.online/@zonca"><i class="bi bi-mastodon" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Deploy Kubernetes on Jetstream 2 with Kubespray 2.21.0</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">kubernetes</div>
                <div class="quarto-category">jetstream2</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 19, 2023</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>This work has been supported by Indiana University and is cross-posted on the <a href="https://docs.jetstream-cloud.org/general/k8kubernetes" rel="canonical">Jetstream 2 official documentation website</a>.</p>
<p>This tutorial will explain how to install Kubernetes on Jetstream 2 relying on Kubespray.</p>
<p>Kubespray is a project built on top of Terraform, for creating Openstack resources, and Ansible, for configuring the Virtual Machines for Kubernetes.</p>
<p>This work is based on Kubespray v2.21.0 which was published in January 2023, which installs Kubernetes v1.25.6, released in December 2022.</p>
<section id="create-jetstream-virtual-machines-with-terraform" class="level2">
<h2 class="anchored" data-anchor-id="create-jetstream-virtual-machines-with-terraform">Create Jetstream Virtual machines with Terraform</h2>
<p>Terraform allows to execute recipes that describe a set of OpenStack resources and their relationship. In the context of this tutorial, we do not need to learn much about Terraform, we will configure and execute the recipe provided by <code>kubespray</code>.</p>
<section id="requirements" class="level3">
<h3 class="anchored" data-anchor-id="requirements">Requirements</h3>
<p>We have been testing with <code>python-openstackclient</code> version 6.1.0, but any recent openstack client should work. install <code>terraform</code> by copying the correct binary to <code>/usr/local/bin/</code>, see <a href="https://www.terraform.io/intro/getting-started/install.html" class="uri">https://www.terraform.io/intro/getting-started/install.html</a>. The requirement is a terraform version <code>&gt; 0.14</code>, this tutorial has been tested with <code>0.14.4</code>. <a href="https://github.com/zonca/jupyterhub-deploy-kubernetes-jetstream/issues/46">Terraform <code>1.1.9</code> and <code>1.2.9</code> do not work</a></p>
</section>
<section id="request-api-access" class="level3">
<h3 class="anchored" data-anchor-id="request-api-access">Request API access</h3>
<p>Follow <a href="https://docs.jetstream-cloud.org/ui/cli/auth/#openrc-files-are-allocation-specific">the instructions in the Jetstream 2 documentation to create application credentials</a>.</p>
<p>Also make sure you are not hitting any of the <a href="https://docs.jetstream-cloud.org/faq/trouble/">issues in the Troubleshooting page</a>, in particular, it is a good idea to set your password within single quotes to avoid special characters being interpreted by the shell:</p>
<pre><code>export OS_APPLICATION_CREDENTIAL_SECRET='xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</code></pre>
<p>Test with:</p>
<pre><code>openstack flavor list</code></pre>
<p>This should return the list of available “sizes” of the Virtual Machines.</p>
<p>You also need to add to the <code>app*openrc.sh</code> also this line:</p>
<pre><code>export OS_APPLICATION_CREDENTIAL_NAME=$OS_APPLICATION_CREDENTIAL_ID</code></pre>
<p>otherwise Ansible will fail with <code>you must either set external_openstack_username or external_openstack_application_credential_name</code>.</p>
</section>
<section id="clone-kubespray" class="level3">
<h3 class="anchored" data-anchor-id="clone-kubespray">Clone kubespray</h3>
<p>We needed to make a few modifications to <code>kubespray</code> to adapt it to Jetstream:</p>
<pre><code>git clone https://github.com/zonca/jetstream_kubespray
git checkout -b branch_v2.21.0 origin/branch_v2.21.0</code></pre>
<p>See an <a href="https://github.com/zonca/jetstream_kubespray/pull/21">overview of my changes compared to the standard <code>kubespray</code> release 2.21.0</a>, compared to previous releases of this tutorial, now the changes in the Terraform recipes are extensive, the good news is that the deployment itself is simpler. We are having all networking handled automatically by Jetstream 2, i.e.&nbsp;instances are automatically assigned to the <code>auto_allocated_network</code>, <code>auto_allocated_router</code> and <code>auto_allocated_subnet</code>, instead of creating dedicated resources with Terraform.</p>
<p>Inside <code>jetstream_kubespray</code>, choose a name for the cluster and copy from my template:</p>
<pre><code>export CLUSTER=yourclustername
cp -r inventory/kubejetstream inventory/$CLUSTER
cd inventory/$CLUSTER</code></pre>
<p>also <code>export CLUSTER=yourclustername</code> is useful to add to the <code>app*openrc.sh</code>.</p>
</section>
<section id="use-a-projects.jetstream-cloud.org-subdomain" class="level3">
<h3 class="anchored" data-anchor-id="use-a-projects.jetstream-cloud.org-subdomain">Use a projects.jetstream-cloud.org subdomain</h3>
<p>One option is to use the Designate Openstack service deployed by Jetstream to get an automatically created domain for the instances. In this case the DNS name will be of the form:</p>
<pre><code>kubejetstream-1.$PROJ.projects.jetstream-cloud.org</code></pre>
<p>where <code>PROJ</code> is the ID of your Jestream 2 allocation:</p>
<pre><code>export PROJ="xxx000000"</code></pre>
<p>The first part of the URL is the instance name, we shortened it removing <code>k8s-master</code> because domains too long do not work with Letsencrypt.</p>
<p>After having executed Terraform, you can pip install on your local machine the package <code>python-designateclient</code> to check what records were created (mind the final period):</p>
<pre><code>openstack recordset list $PROJ.projects.jetstream-cloud.org.</code></pre>
<p>As usual with stuff related to DNS, there are delays, so your record could take up to 1 hour to work, or if you delete the instance and create it again with another IP it could take hours to update.</p>
<p>For debugging purposes it is useful to use <code>nslookup</code>:</p>
<pre><code>nslookup ${CLUSTER}-1.$PROJ.projects.jetstream-cloud.org</code></pre>
<p>also directly at the source nameservers:</p>
<pre><code>nslookup ${CLUSTER}-1.$PROJ.projects.jetstream-cloud.org js2.jetstream-cloud.org</code></pre>
<p>Instead, if you have a way of getting a domain outside of Jetstream, better reserve a floating IP, see below.</p>
</section>
<section id="reserve-a-floating-ip" class="level3">
<h3 class="anchored" data-anchor-id="reserve-a-floating-ip">Reserve a floating IP</h3>
<p>We prefer not to have a floating IP handled by Terraform, otherwise it would be released every time we need to redeploy the cluster, better create it beforehand:</p>
<pre><code>openstack floating ip create public</code></pre>
<p>This will return a public floating IP address, it can also be accessed with:</p>
<pre><code>openstack floating ip list</code></pre>
<p>It is useful to save the IP into the <code>app*openrc.sh</code>, so that every time you load the credentials you also get the address of the master node.</p>
<pre><code>export IP=149.xxx.xxx.xxx</code></pre>
</section>
<section id="run-terraform" class="level3">
<h3 class="anchored" data-anchor-id="run-terraform">Run Terraform</h3>
<p>Open and modify <code>cluster.tfvars</code>, choose your image (by default Ubuntu 20) and number of nodes and the flavor of the nodes, by default they are medium instances (<code>"4"</code>). See the entries marked as <code>REPLACE</code> and replace them according to the instructions provided.</p>
<p>Paste the floating ip created previously into <code>k8s_master_fips</code>, unless you are using a projects.jetstream-cloud.org subdomain.</p>
<p>Initialize Terraform:</p>
<pre><code>bash terraform_init.sh</code></pre>
<p>Create the resources:</p>
<pre><code>bash terraform_apply.sh</code></pre>
<p>Terraform is very fast in building all the resources, sometimes resources are not ready yet, so the Apply command fails, just run it again, it happens regularly, nothing to worry about.</p>
<p>You can SSH into the master node with:</p>
<pre><code>ssh ubuntu@$IP</code></pre>
<p>Inspect with Openstack the resources created:</p>
<pre><code>openstack server list
openstack network list</code></pre>
<p>You can cleanup the virtual machines and all other Openstack resources (all data is lost) with <code>bash terraform_destroy.sh</code>. The floating IP won’t be released so we can create a cluster again from scratch with the same IP address.</p>
</section>
</section>
<section id="install-and-test-ansible" class="level2">
<h2 class="anchored" data-anchor-id="install-and-test-ansible">Install and test Ansible</h2>
<p>Change folder back to the root of the <code>jetstream_kubespray</code> repository,</p>
<p>First make sure you have a recent version of <code>ansible</code> installed, tested with <code>2.10.15</code>, you also need additional modules, so first run:</p>
<pre><code>pip install -r requirements.txt</code></pre>
<p>This <code>pip</code> script installs a predefined version of ansible, currently <code>2.10.15</code>, so it is useful to create a <code>virtualenv</code> or a conda environment and install packages inside that.</p>
<p>Then following the <a href="https://github.com/kubernetes-incubator/kubespray/blob/master/contrib/terraform/openstack/README.md#ansible"><code>kubespray</code> documentation</a>, we setup <code>ssh-agent</code> so that <code>ansible</code> can SSH from the machine with public IP to the others:</p>
<pre><code>eval $(ssh-agent -s)
ssh-add ~/.ssh/id_rsa</code></pre>
<p>Test the connection through ansible:</p>
<pre><code>ansible -i inventory/$CLUSTER/hosts -m ping all</code></pre>
</section>
<section id="install-kubernetes-with-kubespray" class="level2">
<h2 class="anchored" data-anchor-id="install-kubernetes-with-kubespray">Install Kubernetes with <code>kubespray</code></h2>
<p>In <code>inventory/$CLUSTER/group_vars/k8s_cluster/k8s-cluster.yml</code>, set the public floating IP of the master instance in <code>supplementary_addresses_in_ssl_keys</code>.</p>
<p>Finally run the full playbook, it is going to take a good 20 minutes:</p>
<pre><code>bash k8s_install.sh</code></pre>
<p>If the playbook fails with “cannot lock the administrative directory”, it is due to the fact that the Virtual Machine is automatically updating so it has locked the APT directory. Just wait a minute and launch it again. It is always safe to run <code>ansible</code> multiple times.</p>
<p>If the playbook gives any error, try to retry the above command, sometimes there are temporary failed tasks, Ansible is designed to be executed multiple times with consistent results.</p>
<p>You should have now a Kubernetes cluster running, test it:</p>
<pre><code>$ ssh ubuntu@$IP
$ sudo su
$ kubectl get pods --all-namespaces
NAMESPACE       NAME                                           READY   STATUS    RESTARTS   AGE
ingress-nginx   ingress-nginx-controller-4xd64                 1/1     Running   0          27m
kube-system     coredns-8474476ff8-9gd8w                       1/1     Running   0          27m
kube-system     coredns-8474476ff8-qtshk                       1/1     Running   0          27m
kube-system     csi-cinder-controllerplugin-9fb5946bf-hwfhp    6/6     Running   0          26m
kube-system     csi-cinder-nodeplugin-r69nl                    3/3     Running   0          26m
kube-system     dns-autoscaler-5ffdc7f89d-s4sj4                1/1     Running   0          27m
kube-system     kube-apiserver-kubejs2-k8s-master-1            1/1     Running   1          66m
kube-system     kube-controller-manager-kubejs2-k8s-master-1   1/1     Running   1          66m
kube-system     kube-flannel-2clqv                             1/1     Running   0          29m
kube-system     kube-flannel-2wbtq                             1/1     Running   0          29m
kube-system     kube-proxy-hmz6t                               1/1     Running   0          30m
kube-system     kube-proxy-xkhjx                               1/1     Running   0          30m
kube-system     kube-scheduler-kubejs2-k8s-master-1            1/1     Running   1          66m
kube-system     nginx-proxy-kubejs2-k8s-node-1                 1/1     Running   0          64m
kube-system     nodelocaldns-jwxg8                             1/1     Running   0          27m
kube-system     nodelocaldns-z4sjl                             1/1     Running   0          27m
kube-system     openstack-cloud-controller-manager-6q28z       1/1     Running   0          29m
kube-system     snapshot-controller-786647474f-7x8zx           1/1     Running   0          25m
</code></pre>
<p>Compare that you have all those services running also in your cluster. We have also configured NGINX to proxy any service that we will later deploy on Kubernetes, test it with:</p>
<pre><code>$ wget localhost
--2022-03-31 06:51:20--  http://localhost/
Resolving localhost (localhost)... 127.0.0.1
Connecting to localhost (localhost)|127.0.0.1|:80... connected.
HTTP request sent, awaiting response... 404 Not Found
2022-03-31 06:51:20 ERROR 404: Not Found.</code></pre>
<p>Error 404 is a good sign, the service is up and serving requests, currently there is nothing to deliver. If you get any other type of error, check that the <code>nginx</code> controller is running:</p>
<pre><code>kubectl get pods -n ingress-nginx</code></pre>
</section>
<section id="set-the-default-storage-class" class="level2">
<h2 class="anchored" data-anchor-id="set-the-default-storage-class">Set the default storage class</h2>
<p>This is not needed anymore, setting Cinder CSI as default storage class is included in the modifications to Kubespray.</p>
</section>
<section id="optional-setup-kubectl-locally" class="level2">
<h2 class="anchored" data-anchor-id="optional-setup-kubectl-locally">(Optional) Setup kubectl locally</h2>
<p>Install <code>kubectl</code> locally, the tutorial has been tested with <code>1.26</code>.</p>
<p>We also set <code>kubeconfig_localhost: true</code>, which copies the <code>kubectl</code> configuration <code>admin.conf</code> to:</p>
<pre><code>inventory/$CLUSTER/artifacts</code></pre>
<p>We have a script to replace the IP with the floating IP of the master node, for this script to work make sure you have exported the variable IP:</p>
<pre><code>bash k8s_configure_kubectl_locally.sh</code></pre>
<p>Finally edit again the <code>app*openrc.sh</code> and add:</p>
<pre><code>export KUBECONFIG=$(pwd -P)/"jetstream_kubespray/inventory/$CLUSTER/artifacts/admin.conf"</code></pre>
</section>
<section id="optional-setup-helm-locally" class="level2">
<h2 class="anchored" data-anchor-id="optional-setup-helm-locally">(Optional) Setup helm locally</h2>
<p>Install helm 3 from <a href="https://github.com/helm/helm/releases">the release page on Github</a></p>
<p>The tutorial was tested with <code>v3.8.1</code>.</p>


</section>

</main> <!-- /main -->
<div>
    <hr>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>