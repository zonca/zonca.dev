<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2018-11-07">

<title>Andrea Zonca - Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Andrea Zonca</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">About</a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../consult.html">Consulting</a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zonca"><i class="bi bi-github" role="img">
</i> 
 </a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/andreazonca"><i class="bi bi-twitter" role="img">
</i> 
 </a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Deploy JupyterHub on a Supercomputer for a workshop or tutorial 2018 edition</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">jupyterhub</div>
                <div class="quarto-category">hpc</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">November 7, 2018</p>
      </div>
    </div>
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p>I described how to deploy JupyterHub with each user session running on a different node of a Supercomputer in <a href="https://arxiv.org/abs/1805.04781">my paper for PEARC18</a>, however things are moving fast in the space and I am employing a different strategy this year, in particular relying on <a href="https://the-littlest-jupyterhub.readthedocs.io">the littlest JupyterHub project</a> for the initial deployment.</p>
<section id="initial-deployment-of-jupyterhub" class="level2">
<h2 class="anchored" data-anchor-id="initial-deployment-of-jupyterhub">Initial deployment of JupyterHub</h2>
<p><a href="https://the-littlest-jupyterhub.readthedocs.io">The littlest JupyterHub project</a> has great documentation on how to deploy JupyterHub working on a single server on a wide array of providers.</p>
<p>In my case I logged in to the <a href="https://dashboard.cloud.sdsc.edu/">dashboard</a> of <a href="http://www.sdsc.edu/services/ci/cloud.html">SDSC Cloud</a>, a OpenStack deployment at the San Diego Supercomputer Center, and requested an instance with 16 GB of RAM and 6 vCPUs with Ubuntu 18.04. Make sure you attach a floating public IP to the instance and open up ports 22 for SSH and 80,443 for HTTP/HTTPS.</p>
<p>Then I followed the <a href="https://the-littlest-jupyterhub.readthedocs.io/en/latest/install/custom-server.html">installation tutorial for custom servers</a>, just make sure that you first create in the virtual machine the admin user you specify in the installation script, also make sure to use the same username of your Github account, as we will later setup Github Authentication.</p>
<p>You can connect to the instance and check JupyterHub is working and you can login with your user and access the admin panel, for SDSC Cloud the address is <code>http://xxx-xxx-xxx-xxx.compute.cloud.sdsc.edu</code>, filled in with the instance floating IP address.</p>
<section id="setup-https" class="level3">
<h3 class="anchored" data-anchor-id="setup-https">Setup HTTPS</h3>
<p>Follow the Littlest JupyterHub documentation on how to get a SSL certificate through Letsencrypt automatically, after this you should be able to access JupyterHub from <code>https://xxx-xxx-xxx-xxx.compute.cloud.sdsc.edu</code> or a custom domain you pointed there.</p>
</section>
</section>
<section id="authentication-with-github" class="level2">
<h2 class="anchored" data-anchor-id="authentication-with-github">Authentication with Github</h2>
<p>Follow the Littlest JupyterHub documentation, just make sure to set the <code>http</code> address and not the <code>https</code> address.</p>
</section>
<section id="interface-with-comet-via-batchspawner" class="level2">
<h2 class="anchored" data-anchor-id="interface-with-comet-via-batchspawner">Interface with Comet via batchspawner</h2>
<p>We want all users to run on Comet as a single “Gateway” user, as JupyterHub executes as the <code>root</code> user on the server, we want to create a SSH key for the <code>root</code> user and copy the public key to the home folder of the gateway user on Comet so that we can SSH without a password.</p>
<p>Instead, if you would like each user to utilize their own XSEDE account, you need them to authenticate via XSEDE and get a certificate from the XSEDE API that can be used to login to Comet on behalf of the user, see <a href="https://github.com/jupyterhub/jupyterhub-deploy-hpc/tree/master/batchspawner-xsedeoauth-sshtunnel-sdsccomet">an example deployment of this</a>.</p>
<p>First install <code>batchspawner</code> with <code>pip</code> in the Python environment of the hub, this is different than the Python environment of the user, you can have access to it logging in with the <code>root</code> user and running:</p>
<pre><code>export PATH=/opt/tljh/hub/bin:${PATH}</code></pre>
<p>Set the configuration file, see <a href="https://gist.github.com/zonca/55f7949983e56088186e99db53548ded"><code>spawner.py</code> on this Gist</a> and copy it into the <code>/opt/tljh/config/jupyterhub_config.d</code> folder, then add the private SSH key of the tunnelbot user, which is a user on the Virtual Machine with no shell (set <code>/bin/false</code> in <code>/etc/passwd</code>) but that can setup a SSH tunnel from Comet back to the Hub.</p>
<p>Also customize all paths and usernames in the file.</p>
<p>Reload the Jupyterhub configuration with:</p>
<pre><code>tljh-config reload</code></pre>
<p>You can then check the Hub logs with <code>sudo journalctl -r -u jupyterhub</code></p>
<p>The most complicated part is making sure that the environment variables defined by JupyterHub, the most important is the token which allows the singleuser server to authenticate itself with the Hub, are correctly propagated through SSH. See in <code>spawner.py</code> how I explicitely pass the variables over SSH.</p>
<p>Also, as all workshop participants access Comet with the same user account, I automatically create a folder with their Github username and checkout the Notebooks for the workshop in that folder. Then start JupyterLab in that folder, so that the users do not interfere, we are not worrying about security here, with the current setup a user can open a terminal inside JupyterLab and access the folder of another person.</p>
</section>
<section id="how-to-setup-the-tunnelbot-user" class="level2">
<h2 class="anchored" data-anchor-id="how-to-setup-the-tunnelbot-user">How to setup the tunnelbot user</h2>
<ul>
<li>On the JupyterHub virtual machine, create a user named <code>tunnelbot</code></li>
<li><code>sudo su tunnelbot</code> to act as that user, then create a key with <code>ssh-keygen</code></li>
<li>enter the <code>.ssh</code> folder and <code>cp id_rsa.pub authorized_keys</code> so that the ssh key can be used from Comet to ssh passwordless to the server</li>
<li>now get the <strong>private key</strong> from <code>/home/tunnelbot/.ssh/id_rsa</code> and paste it into <code>spawner.py</code></li>
<li>now make sure you set the shell of <code>tunnelbot</code> to <code>/bin/false</code> in <code>/etc/passwd/</code></li>
<li>for increased security, please also follow the steps in <a href="https://askubuntu.com/questions/48129/how-to-create-a-restricted-ssh-user-for-port-forwarding">this stackoverflow answer</a></li>
</ul>
</section>
<section id="acknowledgments" class="level2">
<h2 class="anchored" data-anchor-id="acknowledgments">Acknowledgments</h2>
<p>Thanks to the Jupyter and JupyterHub teams for releasing great software with outstanding documentation, in particular Yuvi Panda for the simplicity and elegance in the design of the Littlest JupyterHub deployment.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
</div> <!-- /content -->



</body></html>