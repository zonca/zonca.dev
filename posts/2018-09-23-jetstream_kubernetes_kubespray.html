<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.171">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2018-09-23">

<title>Andrea Zonca - Deploy Kubernetes on Jetstream with Kubespray 1/3</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Andrea Zonca</span>
    </a>
  </div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../about.html">
 <span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../consult.html">
 <span class="menu-text">Consulting</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/zonca"><i class="bi bi-github" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/andreazonca"><i class="bi bi-twitter" role="img">
</i> 
 <span class="menu-text"></span></a>
  </li>  
</ul>
              <div id="quarto-search" class="" title="Search"></div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Deploy Kubernetes on Jetstream with Kubespray 1/3</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">kubernetes</div>
                <div class="quarto-category">jetstream</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">September 23, 2018</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">




<p><strong>This tutorial is obsolete, check the <a href="https://zonca.dev/2020/06/kubernetes-jetstream-kubespray.html">updated version of the tutorial</a></strong></p>
<p>The purpose of this tutorial series is to deploy Jupyterhub on top of Kubernetes on Jetstream. This material was presented as a tutorial at the Gateways 2018 conference, see also <a href="https://figshare.com/articles/Hands-on_Tutorial_Deploying_Kubernetes_and_JupyterHub_on_Jetstream/7137884">the slides on Figshare</a>.</p>
<p>Compared to my <a href="https://zonca.github.io/2017/12/scalable-jupyterhub-kubernetes-jetstream.html">initial tutorial</a>, I focused on improving automation. Instead of creating Jetstream instances via the Atmosphere web interface and then SSHing into the instances and run <code>kubeadm</code> based commands to setup Docker and Kubernetes we will:</p>
<ul>
<li>Use the <code>terraform</code> recipe part of the <code>kubespray</code> project to interface with the Jetstream API and create a cluster of virtual machines</li>
<li>Run the <code>kubespray</code> ansible recipe to setup a production-ready Kubernetes deployment, optionally with High Availability features like redundant master nodes and much more, see <a href="http://kubespray.io">kubepray.io</a>.</li>
</ul>
<section id="create-jetstream-virtual-machines-with-terraform" class="level2">
<h2 class="anchored" data-anchor-id="create-jetstream-virtual-machines-with-terraform">Create Jetstream Virtual machines with Terraform</h2>
<p><code>kubespray</code> is able to deploy production-ready Kubernetes deployments and initially targeted only commercial cloud platforms.</p>
<p>They recently added support for Openstack via a Terraform recipe which is available in <a href="https://github.com/kubernetes-incubator/kubespray/tree/master/contrib/terraform/openstack">their Github repository</a>.</p>
<p>Terraform allows to execute recipes that describe a set of OpenStack resources and their relationship. In the context of this tutorial, we do not need to learn much about Terraform, we will configure and execute the recipe provided by <code>kubespray</code>.</p>
<section id="requirements" class="level3">
<h3 class="anchored" data-anchor-id="requirements">Requirements</h3>
<p>On a Ubuntu 18.04 install <code>python3-openstackclient</code> with APT. Any other platform works as well, also install <code>terraform</code> by copying the correct binary to <code>/usr/local/bin/</code>, see <a href="https://www.terraform.io/intro/getting-started/install.html" class="uri">https://www.terraform.io/intro/getting-started/install.html</a>. The current version of the recipe requires Terraform <code>0.11.x</code>, <strong>not the newest 0.12</strong>.</p>
</section>
<section id="request-api-access" class="level3">
<h3 class="anchored" data-anchor-id="request-api-access">Request API access</h3>
<p>In order to make sure your XSEDE account can access the Jetstream API, you need to contact the Helpdesk, see the <a href="https://iujetstream.atlassian.net/wiki/spaces/JWT/pages/39682057/Using+the+Jetstream+API">instructions on the Jetstream Wiki</a>. You will also receive your <strong>TACC</strong> password, which could be different than your XSEDE one (username is generally the same).</p>
<p>Login to the TACC Horizon panel at <a href="https://tacc.jetstream-cloud.org/dashboard" class="uri">https://tacc.jetstream-cloud.org/dashboard</a>, this is basically the low level web interface to OpenStack, a lot more complex and powerful than Atmosphere available at <a href="https://use.jetstream-cloud.org/application" class="uri">https://use.jetstream-cloud.org/application</a>. Use <code>tacc</code> as domain, your TACC username (generally the same as your XSEDE username) and your TACC password.</p>
<p>First choose the right project you would like to charge to in the top dropdown menu (see the XSEDE website if you don’t recognize the grant code).</p>
<p>Click on Compute / API Access and download the OpenRC V3 authentication file to your machine. Source it typing:</p>
<pre><code>source XX-XXXXXXXX-openrc.sh</code></pre>
<p>it should ask for your TACC password. This configures all the environment variables needed by the <code>openstack</code> command line tool to interface with the Openstack API.</p>
<p>Test with:</p>
<pre><code>openstack flavor list</code></pre>
<p>This should return the list of available “sizes” of the Virtual Machines.</p>
</section>
<section id="clone-kubespray" class="level3">
<h3 class="anchored" data-anchor-id="clone-kubespray">Clone kubespray</h3>
<p>I had to make a few modifications to <code>kubespray</code> to adapt it to Jetstream or backport bug fixes not merged yet, so currently better use my fork of <code>kubespray</code>:</p>
<pre><code>git clone https://github.com/zonca/jetstream_kubespray</code></pre>
<p>See an <a href="https://github.com/zonca/jetstream_kubespray/pull/2">overview of my changes compared to the standard <code>kubespray</code> release 2.6.0</a>.</p>
</section>
<section id="run-terraform" class="level3">
<h3 class="anchored" data-anchor-id="run-terraform">Run Terraform</h3>
<p>Inside <code>jetstream_kubespray</code>, copy from my template:</p>
<pre><code>export CLUSTER=$USER
cp -LRp inventory/zonca_kubespray inventory/$CLUSTER
cd inventory/$CLUSTER</code></pre>
<p>Open and modify <code>cluster.tf</code>, choose your image and number of nodes. Make sure to change the network name to something unique, like the expanded form of <code>$CLUSTER_network</code>.</p>
<p>You can find suitable images (they need to be JS-API-Featured, you cannot use the same instances used in Atmosphere):</p>
<pre><code>openstack image list | grep "JS-API"</code></pre>
<p>I already preconfigured the network UUID both for IU and TACC, but you can crosscheck looking for the <code>public</code> network in:</p>
<pre><code>openstack network list</code></pre>
<p>Initialize Terraform:</p>
<pre><code>bash terraform_init.sh</code></pre>
<p>Create the resources:</p>
<pre><code>bash terraform_apply.sh</code></pre>
<p>The last output log of Terraform should contain the IP of the master node <code>k8s_master_fips</code>, wait for it to boot then SSH in with:</p>
<pre><code>ssh ubuntu@$IP</code></pre>
<p>or <code>centos@$IP</code> for CentOS images.</p>
<p>Inspect with Openstack the resources created:</p>
<pre><code>openstack server list
openstack network list</code></pre>
<p>You can cleanup the virtual machines and all other Openstack resources (all data is lost) with <code>bash terraform_destroy.sh</code>.</p>
</section>
</section>
<section id="install-kubernetes-with-kubespray" class="level2">
<h2 class="anchored" data-anchor-id="install-kubernetes-with-kubespray">Install Kubernetes with <code>kubespray</code></h2>
<p>Change folder back to the root of the <code>jetstream_kubespray</code> repository,</p>
<p>First make sure you have a recent version of <code>ansible</code> installed, you also need additional modules, so first run:</p>
<pre><code>pip install -r requirements.txt</code></pre>
<p>It is useful to create a <code>virtualenv</code> and install packages inside that. This will also install <code>ansible</code>, it is important to install <code>ansible</code> with <code>pip</code> so that the path to access the modules is correct. So remove any pre-installed <code>ansible</code>.</p>
<p>Then following the <a href="https://github.com/kubernetes-incubator/kubespray/blob/master/contrib/terraform/openstack/README.md#ansible"><code>kubespray</code> documentation</a>, we setup <code>ssh-agent</code> so that <code>ansible</code> can SSH from the machine with public IP to the others:</p>
<pre><code>eval $(ssh-agent -s)
ssh-add ~/.ssh/id_rsa</code></pre>
<p>Test the connection through ansible:</p>
<pre><code>ansible -i inventory/$CLUSTER/hosts -m ping all</code></pre>
<p>If a server is not answering to ping, first try to reboot it:</p>
<pre><code>openstack server reboot $CLUSTER-k8s-node-nf-1</code></pre>
<p>Or delete it and run <code>terraform_apply.sh</code> to create it again.</p>
<p>check <code>inventory/$CLUSTER/group_vars/all.yml</code>, in particular <code>bootstrap_os</code>, I setup <code>ubuntu</code>, change it to <code>centos</code> if you used the Centos 7 base image.</p>
<p>Due to a bug in the recipe, run ( see details in the Troubleshooting notes below):</p>
<pre><code>export OS_TENANT_ID=$OS_PROJECT_ID</code></pre>
<p>Finally run the full playbook, it is going to take a good 10 minutes:</p>
<pre><code>ansible-playbook --become -i inventory/$CLUSTER/hosts cluster.yml</code></pre>
<p>If the playbook fails with “cannot lock the administrative directory”, it is due to the fact that the Virtual Machine is automatically updating so it has locked the APT directory. Just wait a minute and launch it again. It is always safe to run <code>ansible</code> multiple times.</p>
<p>If the playbook gives any error, try to retry the above command, sometimes there are temporary failed tasks, Ansible is designed to be executed multiple times with consistent results.</p>
<p>You should have now a Kubernetes cluster running, test it:</p>
<pre><code>$ ssh ubuntu@$IP
$ kubectl get pods --all-namespaces
NAMESPACE       NAME                                                   READY     STATUS    RESTARTS   AGE
cert-manager    cert-manager-78fb746bc7-w9r94                          1/1       Running   0          2h
ingress-nginx   default-backend-v1.4-7795cd847d-g25d8                  1/1       Running   0          2h
ingress-nginx   ingress-nginx-controller-bdjq7                         1/1       Running   0          2h
kube-system     kube-apiserver-zonca-kubespray-k8s-master-1            1/1       Running   0          2h
kube-system     kube-controller-manager-zonca-kubespray-k8s-master-1   1/1       Running   0          2h
kube-system     kube-dns-69f4c8fc58-6vhhs                              3/3       Running   0          2h
kube-system     kube-dns-69f4c8fc58-9jn25                              3/3       Running   0          2h
kube-system     kube-flannel-7hd24                                     2/2       Running   0          2h
kube-system     kube-flannel-lhsvx                                     2/2       Running   0          2h
kube-system     kube-proxy-zonca-kubespray-k8s-master-1                1/1       Running   0          2h
kube-system     kube-proxy-zonca-kubespray-k8s-node-nf-1               1/1       Running   0          2h
kube-system     kube-scheduler-zonca-kubespray-k8s-master-1            1/1       Running   0          2h
kube-system     kubedns-autoscaler-565b49bbc6-7wttm                    1/1       Running   0          2h
kube-system     kubernetes-dashboard-6d4dfd56cb-24f98                  1/1       Running   0          2h
kube-system     nginx-proxy-zonca-kubespray-k8s-node-nf-1              1/1       Running   0          2h
kube-system     tiller-deploy-5c688d5f9b-fpfpg                         1/1       Running   0          2h</code></pre>
<p>Compare that you have all those services running also in your cluster. We have also configured NGINX to proxy any service that we will later deploy on Kubernetes, test it with:</p>
<pre><code>$ wget localhost
--2018-09-24 03:01:14--  http://localhost/
Resolving localhost (localhost)... 127.0.0.1
Connecting to localhost (localhost)|127.0.0.1|:80... connected.
HTTP request sent, awaiting response... 404 Not Found
2018-09-24 03:01:14 ERROR 404: Not Found.</code></pre>
<p>Error 404 is a good sign, the service is up and serving requests, currently there is nothing to deliver. Finally test that the routing through the Jetstream instance is working correctly by opening your browser and test that if you access <code>js-XX-XXX.jetstream-cloud.org</code> you also get a <code>default backend - 404</code> message. If any of the tests hangs or cannot connect, there is probably a networking issue.</p>
</section>
<section id="next" class="level2">
<h2 class="anchored" data-anchor-id="next">Next</h2>
<p>Next you can <a href="https://zonca.github.io/2018/09/kubernetes-jetstream-kubespray-explore.html">explore the kubernetes deployment to learn more about how you deploy resources in the second part of my tutorial</a> or skip it and proceed directly to the <a href="http://zonca.github.io/2018/09/kubernetes-jetstream-kubespray-jupyterhub.html">third and final part of the tutorial and deploy Jupyterhub and configure it with HTTPS</a>.</p>
<section id="troubleshooting-notes" class="level3">
<h3 class="anchored" data-anchor-id="troubleshooting-notes">Troubleshooting notes</h3>
<p>For future reference, disregard this.</p>
<p>Failing ansible task: <code>openstack_tenant_id is missing</code></p>
<p>fixed with: <code>export OS_TENANT_ID=$OS_PROJECT_ID</code>, this should be fixed once <a href="https://github.com/kubernetes-incubator/kubespray/pull/2783" class="uri">https://github.com/kubernetes-incubator/kubespray/pull/2783</a> is merged, anyway this is not blocking.</p>
<p>Failing task <code>Write cacert file</code>:</p>
<p>NOTE: had to cherry-pick a commit from <a href="https://github.com/kubernetes-incubator/kubespray/pull/3280" class="uri">https://github.com/kubernetes-incubator/kubespray/pull/3280</a>, this will be unnecessary once this is fixed upstream</p>
</section>
</section>
<section id="optional-setup-kubectl-locally" class="level2">
<h2 class="anchored" data-anchor-id="optional-setup-kubectl-locally">(Optional) Setup kubectl locally</h2>
<p>We also set <code>kubectl_localhost: true</code> and <code>kubeconfig_localhost: true</code>. so that <code>kubectl</code> is installed on your local machine</p>
<p>it also copies <code>admin.conf</code> to:</p>
<pre><code>inventory/$CLUSTER/artifacts</code></pre>
<p>now copy that to <code>~/.kube/config</code></p>
<p>this has an issue, it has the internal IP of the Jetstream master. We cannot replace it with the public floating ip because the certificate is not valid for that. Best workaround is to replace it with <code>127.0.0.1</code> inside <code>~/.kube/config</code> at the <code>server:</code> key. Then make a SSH tunnel:</p>
<pre><code>ssh ubuntu@$IP -f -L 6443:localhost:6443 sleep 3h</code></pre>
<ul>
<li><code>-f</code> sends the process in the background</li>
<li>executing <code>sleep</code> for 3 hours makes the tunnel automatically close after 3 hours, otherwise <code>-N</code> would keep the tunnel permanently open</li>
</ul>
</section>
<section id="optional-setup-helm-locally" class="level2">
<h2 class="anchored" data-anchor-id="optional-setup-helm-locally">(Optional) Setup helm locally</h2>
<p>ssh into the master node, check helm version with:</p>
<pre><code>helm version</code></pre>
<p>Download the same binary version from <a href="https://github.com/helm/helm/releases">the release page on Github</a> and copy the binary to <code>/url/local/bin</code>.</p>
<pre><code>helm ls</code></pre>


</section>

</main> <!-- /main -->
<div>
    <hr>
<script type="text/javascript" src="https://cdnjs.buymeacoffee.com/1.0.0/button.prod.min.js" data-name="bmc-button" data-slug="zonca" data-color="#FFDD00" data-emoji="☕" data-font="Cookie" data-text="Buy me a coffee" data-outline-color="#000000" data-font-color="#000000" data-coffee-color="#ffffff"></script>
</div>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>